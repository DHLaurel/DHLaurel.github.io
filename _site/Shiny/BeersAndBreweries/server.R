#

# The skeleton code for the below was largely generated by ChatGPT. Thanks ChatGPT!

# This is the server logic of a Shiny web application. You can run the
# application by clicking 'Run App' above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)
library(ggplot2)
library(dplyr)
library(mice) # multi-variate imputation


# Globals
brew_dat = read.csv("./Breweries.csv")
# 
# # Define server logic required to draw a histogram
# function(input, output, session) {
# 
#     # output$distPlot <- renderPlot({
#     # 
#     #     # generate bins based on input$bins from ui.R
#     #     x    <- faithful[, 2]
#     #     bins <- seq(min(x), max(x), length.out = input$bins + 1)
#     # 
#     #     # draw the histogram with the specified number of bins
#     #     hist(x, breaks = bins, col = 'darkgray', border = 'white',
#     #          xlab = 'Waiting time to next eruption (in mins)',
#     #          main = 'Histogram of waiting times')
#     # 
#     # })
# 
#     output$distPlot <- renderPlot({
#       
#       # generate bins based on input$bins from ui.R
#       x    <- faithful[, 2]
#       bins <- seq(min(x), max(x), length.out = input$bins + 1)
#       
#       # draw the histogram with the specified number of bins
#       hist(x, breaks = bins, col = 'darkgray', border = 'white',
#            xlab = 'Waiting time to next eruption (in mins)',
#            main = 'Histogram of waiting times')
#       
#     })
# }

function(input, output) {
  
  # Load data from file
  data <- reactive({
    req(input$data_file)
    beer_dat <- read.csv(input$data_file$datapath)
    merge(x = brew_dat, y = beer_dat, by.x = "Brew_ID", by.y = "Brewery_id")
    
  })
  
  # Create IBU histogram or boxplot
  output$ibu_plot <- renderPlot({
    plot_data <- data()  
    if (input$State != "" & input$State != "All") {
      plot_data <- plot_data %>% filter(State == input$State)
    }
    if (input$plot_type == "hist") {
      ggplot(plot_data, aes(x = IBU)) + 
        geom_histogram(binwidth = 5) +
        labs(x = "IBU", y = "Count")
    } else {
      ggplot(plot_data, aes(x = "IBU", y = IBU)) +
        geom_boxplot() +
        labs(x = "", y = "IBU")
    }
  })
  
  # Create ABV histogram or boxplot
  output$abv_plot <- renderPlot({
    plot_data <- data()  
    if (input$State != "" & input$State != "All") {
      plot_data <- plot_data %>% filter(State == input$State)
    }
    if (input$plot_type == "hist") {
      ggplot(plot_data, aes(x = ABV*100)) + 
        geom_histogram(binwidth = 0.5) +
        labs(x = "ABV (%)", y = "Count")
    } else {
      ggplot(plot_data, aes(x = "ABV", y = ABV)) +
        geom_boxplot() +
        labs(x = "", y = "ABV")
    }
  })
  
  # Create scatter plot of IBU vs. ABV with optional linear regression line
  output$ibu_abv_plot <- renderPlot({
    plot_data <- data()  
    if (input$State != "" & input$State != "All") {
      plot_data <- plot_data %>% filter(State == input$State)
    }
    plot <- ggplot(plot_data, aes(x = IBU, y = ABV)) + geom_point()
    if (input$show_lm) {
      plot <- plot + geom_smooth(method = "lm", se = FALSE)
    }
    plot
  })
  
  # Create additional plot (in this case, a bar plot of beer styles)
  output$additional_plot <- renderPlot({
    plot_data <- data()
    if (input$State != "" & input$State != "All") {
      plot_data <- plot_data %>% filter(State == input$State)
    }
    ggplot(plot_data, aes(x = factor(Style))) +
      geom_bar() +
      labs(x = "Beer Style", y = "Count") +
      theme(axis.text.x = element_text(angle = 90, hjust = 1))
  })
  
  output$final_plot <- renderPlot({
    plot_data <- data()
    if (input$State != "" & input$State != "All") {
      plot_data <- plot_data %>% filter(State == input$State)
    }
    beer_brew_whole <- data()
    beer_brew_whole$ABV <- complete(mice(beer_brew_whole, method="pmm"))$ABV # Use predictive mean imputation for now, fill in just ABV rows (fewer) before IBU
    beer_brew_whole$IBU <- complete(mice(beer_brew_whole, method="pmm"))$IBU 
    
    bb_ales <- beer_brew_whole[grepl("Ale", beer_brew_whole$Style, ignore.case = TRUE) | grepl("IPA", beer_brew_whole$Style, ignore.case=TRUE), ]
    bb_ales <- bb_ales[!grepl("Lager", bb_ales$Style, ignore.case=TRUE),]
    
    bb_ales$IsIPA <- grepl("IPA", bb_ales$Style, ignore.case=TRUE)

    bb_ales$IsIPA[bb_ales$IsIPA == TRUE] <- "IPA" 
    bb_ales$IsIPA[bb_ales$IsIPA == FALSE] <- "Not an IPA" 
    
    plot_data <- bb_ales  
    if (input$State != "" & input$State != "All") {
      plot_data <- plot_data %>% filter(State == input$State)
    }

    ggplot(plot_data, aes(x = IBU, y = ABV * 100.0, color = IsIPA)) +
      geom_point(position = "jitter", alpha = 0.7) +
      labs(title = "IPA Prediction by \nABV and IBU", color = "", y = "ABV (%)") +
      theme(axis.title=element_text(size=12)) +
      xlim(0, 150) + ylim(2,10)
  })
  
}